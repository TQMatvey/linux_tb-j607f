// SPDX-License-Identifier: BSD-3-Clause
/*
 * Copyright (c) 2021, Luca Weiss <luca@z3ntu.xyz>
 */

/dts-v1/;

#include <dt-bindings/regulator/qcom,rpmh-regulator.h>
#include "sm7225.dtsi"

/ {
	model = "Fairphone 4";
	compatible = "fairphone,fp4", "qcom,sm7225";

	/* required for bootloader to select correct board */
	qcom,msm-id = <0x1b2 0x10000 0x1cb 0x10000>;
	qcom,board-id = <0x08 0x20>;

	aliases {
		serial0 = &uart2;
	};

	chosen {
		//stdout-path = "serial0:115200n8";
		//bootargs = "earlycon=tty0 console=tty0 console=ttyMSM0,115200";

		#address-cells = <2>;
		#size-cells = <2>;
		ranges;

		stdout-path = "framebuffer0";

		framebuffer0: framebuffer@a000000 {
			compatible = "simple-framebuffer";
			reg = <0 0xa0000000 0 (2340 * 1080 * 4)>;
			width = <1080>;
			height = <2340>;
			stride = <(1080 * 4)>;
			format = "a8r8g8b8";
			status = "okay";
		};
	};

	reserved-memory {
		/* The rmtfs_mem needs to be guarded due to "XPU limitations"
		 * it is otherwise possible for an allocation adjacent to the
		 * rmtfs_mem region to trigger an XPU violation, causing a crash.
		 */
		rmtfs_lower_guard: memory@efe00000 {
			no-map;
			reg = <0 0xefe00000 0 0x1000>;
		};
		/*
		 * The rmtfs memory region in downstream is 'dynamically allocated'
		 * but given the same address every time. Hard code it as this address is
		 * where the modem firmware expects it to be.
		 */
		rmtfs_mem: memory@efe01000 {
			compatible = "qcom,rmtfs-mem";
			reg = <0 0xefe01000 0 0x600000>;
			no-map;

			qcom,client-id = <1>;
			//qcom,vmid = <15>;
		};
		rmtfs_upper_guard: memory@f0401000 {
			no-map;
			reg = <0 0xf0401000 0 0x1000>;
		};
	};

	// HACKS
	reserved-memory {
		ranges;
		#size-cells = <0x02>;
		#address-cells = <0x02>;

		linux,cma {
			reusable;
			size = <0x00 0x2000000>;
			compatible = "shared-dma-pool";
			alloc-ranges = <0x00 0x00 0x00 0xffffffff>;
			alignment = <0x00 0x400000>;
			linux,cma-default;
		};

		wlan_fw_region@8b500000 {
			no-map;
			reg = <0x00 0x8b500000 0x00 0x200000>;
			compatible = "removed-dma-pool";
		};

		hyp_region@80000000 {
			no-map;
			reg = <0x00 0x80000000 0x00 0x600000>;
			compatible = "removed-dma-pool";
		};

		cdsp_regions@86f00000 {
			no-map;
			reg = <0x00 0x86f00000 0x00 0x1e00000>;
			compatible = "removed-dma-pool";
		};

		secure_display_region {
			reusable;
			size = <0x00 0x8c00000>;
			compatible = "shared-dma-pool";
			alloc-ranges = <0x00 0x00 0x00 0xffffffff>;
			alignment = <0x00 0x400000>;
		};

		smem@80900000 {
			no-map;
			reg = <0x00 0x80900000 0x00 0x200000>;
			compatible = "removed-dma-pool";
		};

		adsp_region {
			reusable;
			size = <0x00 0x800000>;
			compatible = "shared-dma-pool";
			alloc-ranges = <0x00 0x00 0x00 0xffffffff>;
			alignment = <0x00 0x400000>;
		};

		camera_region@86000000 {
			no-map;
			reg = <0x00 0x86000000 0x00 0x500000>;
			compatible = "removed-dma-pool";
		};

		pil_adsp_region@88d00000 {
			no-map;
			reg = <0x00 0x88d00000 0x00 0x2800000>;
			compatible = "removed-dma-pool";
		};

		ipa_gsi_region@8b710000 {
			no-map;
			reg = <0x00 0x8b710000 0x00 0x5400>;
			compatible = "removed-dma-pool";
		};

		cont_splash_region {
			no-map; // CUSTOM!
			reg = <0x00 0xa0000000 0x00 0x2300000>;
			label = "cont_splash_region";
		};

		xbl_aop_mem@80700000 {
			no-map;
			reg = <0x00 0x80700000 0x00 0x160000>;
			compatible = "removed-dma-pool";
		};

		cdsp_sec_regions@80b00000 {
			no-map;
			reg = <0x00 0x80b00000 0x00 0x1e00000>;
			compatible = "removed-dma-pool";
		};

		ipa_fw_region@8b700000 {
			no-map;
			reg = <0x00 0x8b700000 0x00 0x10000>;
			compatible = "removed-dma-pool";
		};

		pil_video_region@86a00000 {
			no-map;
			reg = <0x00 0x86a00000 0x00 0x500000>;
			compatible = "removed-dma-pool";
		};

		modem_region@8b800000 {
			no-map;
			reg = <0x00 0x8b800000 0x00 0xf800000>;
			compatible = "removed-dma-pool";
		};

		dfps_data_region {
			reg = <0x00 0xa2300000 0x00 0x100000>;
			label = "dfps_data_region";
		};

		gpu_region@8b715400 {
			no-map;
			reg = <0x00 0x8b715400 0x00 0x2000>;
			compatible = "removed-dma-pool";
		};

		qseecom_ta_region {
			reusable;
			size = <0x00 0x1000000>;
			compatible = "shared-dma-pool";
			alloc-ranges = <0x00 0x00 0x00 0xffffffff>;
			alignment = <0x00 0x400000>;
		};

		reserved-memory@80860000 {
			no-map;
			reg = <0x00 0x80860000 0x00 0x20000>;
			compatible = "qcom,cmd-db";
		};

		removed_region@c0000000 {
			no-map;
			reg = <0x00 0xc0000000 0x00 0x3900000>;
			compatible = "removed-dma-pool";
		};

		pil_npu_region@86500000 {
			no-map;
			reg = <0x00 0x86500000 0x00 0x500000>;
			compatible = "removed-dma-pool";
		};

		sec_apps_region@808ff000 {
			no-map;
			reg = <0x00 0x808ff000 0x00 0x1000>;
			compatible = "removed-dma-pool";
		};

		mem_dump_region {
			reusable;
			size = <0x00 0x2800000>;
			compatible = "shared-dma-pool";
			alloc-ranges = <0x00 0x00 0x00 0xffffffff>;
		};

		qseecom_region {
			reusable;
			size = <0x00 0x1400000>;
			compatible = "shared-dma-pool";
			alloc-ranges = <0x00 0x00 0x00 0xffffffff>;
			alignment = <0x00 0x400000>;
		};

		disp_rdump_region@0xa0000000 {
			reg = <0x00 0xa0000000 0x00 0x2300000>;
			label = "disp_rdump_region";
		};
	};
	// HACKS
};

&usb_1 {
	status = "okay";
};

&usb_1_hsphy {
	status = "okay";

	// VDD_USBHS_0P9 = DS vdd-supply &L18A
	// VDD_A_USBHS_1P8 = DS vdda18-supply &L2A
	// VDD_A_USBHS_3P1 = DS vdda33-supply &L3A
	//vdda-pll-supply = <>;
	//vdda-phy-dpdm-supply = <>;
	vdda18-supply = <&vreg_l2a>;
	vdda33-supply = <&vreg_l3a>;
	refgen-supply = <&vreg_l22a>;
	vdd-supply = <&vreg_l18a>;
};

&qupv3_id_1 {
	status = "okay";
};

&uart2 {
	status = "okay";
};

&qupv3_id_0 {
	status = "okay";
};

&qupv3_se0_i2c {
	// TODO qupv3_se0_i2c -> aw882xx_smartpa@34 & aw882xx_smartpa@35
	status = "okay";
};

&qupv3_se8_i2c {
	// TODO qupv3_se8_i2c -> himax_ts@48
	status = "okay";
};

&qupv3_se10_i2c {
	// TODO qupv3_se10_i2c -> aw8695_haptic@5A
	status = "okay";
};

&sdhc_2 {
	status = "okay";
};

&apps_rsc {
	pm6350-rpmh-regulators {
		compatible = "qcom,pm6350-rpmh-regulators";
		qcom,pmic-id = "a";
		//status = "disabled";

		// TODO supplies
		// TODO initial-mode for all are RPMH_REGULATOR_MODE_LPM downstream

		vreg_s1a: smps1 {
			regulator-min-microvolt = <1000000>;
			regulator-max-microvolt = <1200000>;
		};

		vreg_s2a: smps2 {
			regulator-min-microvolt = <1503000>;
			regulator-max-microvolt = <2048000>;
		};

		vreg_l2a: ldo2 {
			regulator-min-microvolt = <1503000>;
			regulator-max-microvolt = <1980000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l3a: ldo3 {
			regulator-min-microvolt = <2700000>;
			regulator-max-microvolt = <3300000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l4a: ldo4 {
			regulator-min-microvolt = <352000>;
			regulator-max-microvolt = <801000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l5a: ldo5 {
			regulator-min-microvolt = <1503000>;
			regulator-max-microvolt = <1980000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l6a: ldo6 {
			regulator-min-microvolt = <1710000>;
			regulator-max-microvolt = <3544000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l7a: ldo7 {
			regulator-min-microvolt = <1620000>;
			regulator-max-microvolt = <1980000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l8a: ldo8 {
			regulator-min-microvolt = <2800000>;
			regulator-max-microvolt = <2800000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l9a: ldo9 {
			regulator-min-microvolt = <1650000>;
			regulator-max-microvolt = <3401000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l11a: ldo11 {
			regulator-min-microvolt = <1800000>;
			regulator-max-microvolt = <2000000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l12a: ldo12 {
			regulator-min-microvolt = <1620000>;
			regulator-max-microvolt = <1980000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l13a: ldo13 {
			regulator-min-microvolt = <570000>;
			regulator-max-microvolt = <650000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l14a: ldo14 {
			regulator-min-microvolt = <1700000>;
			regulator-max-microvolt = <1900000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l15a: ldo15 {
			regulator-min-microvolt = <1100000>;
			regulator-max-microvolt = <1305000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l16a: ldo16 {
			regulator-min-microvolt = <830000>;
			regulator-max-microvolt = <921000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l18a: ldo18 {
			regulator-min-microvolt = <788000>;
			regulator-max-microvolt = <1049000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l19a: ldo19 {
			regulator-min-microvolt = <1080000>;
			regulator-max-microvolt = <1305000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l20a: ldo20 {
			regulator-min-microvolt = <530000>;
			regulator-max-microvolt = <801000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l21a: ldo21 {
			regulator-min-microvolt = <751000>;
			regulator-max-microvolt = <825000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l22a: ldo22 {
			regulator-min-microvolt = <1080000>;
			regulator-max-microvolt = <1305000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};
	};

	pm6150a-rpmh-regulators {
		compatible = "qcom,pm6150a-rpmh-regulators";
		qcom,pmic-id = "e";

		// TODO supplies
		// TODO initial-mode for all are RPMH_REGULATOR_MODE_LPM downstream

		vreg_s8e: smps8 {
			regulator-min-microvolt = <313000>;
			regulator-max-microvolt = <1395000>;
		};

		vreg_l1e: ldo1 {
			regulator-min-microvolt = <1620000>;
			regulator-max-microvolt = <1980000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l2e: ldo2 {
			regulator-min-microvolt = <1170000>;
			regulator-max-microvolt = <1305000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l3e: ldo3 {
			regulator-min-microvolt = <1100000>;
			regulator-max-microvolt = <1299000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l4e: ldo4 {
			regulator-min-microvolt = <1620000>;
			regulator-max-microvolt = <3300000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l5e: ldo5 {
			regulator-min-microvolt = <1620000>;
			regulator-max-microvolt = <3300000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l6e: ldo6 {
			regulator-min-microvolt = <1700000>;
			regulator-max-microvolt = <3544000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l7e: ldo7 {
			regulator-min-microvolt = <2700000>;
			regulator-max-microvolt = <3544000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l8e: ldo8 {
			regulator-min-microvolt = <1620000>;
			regulator-max-microvolt = <2000000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l9e: ldo9 {
			regulator-min-microvolt = <2700000>;
			regulator-max-microvolt = <3544000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l10e: ldo10 {
			regulator-min-microvolt = <3000000>;
			regulator-max-microvolt = <3401000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_l11e: ldo11 {
			regulator-min-microvolt = <3000000>;
			regulator-max-microvolt = <3401000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_HPM>;
		};

		vreg_bob: bob {
			regulator-min-microvolt = <1620000>;
			regulator-max-microvolt = <5492000>;
			regulator-initial-mode = <RPMH_REGULATOR_MODE_AUTO>;
			regulator-allow-bypass;
		};
	};
};
